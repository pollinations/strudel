"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const yt=require("@strudel.cycles/core");function wt(a){const o=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(a){for(const r in a)if(r!=="default"){const h=Object.getOwnPropertyDescriptor(a,r);Object.defineProperty(o,r,h.get?h:{enumerable:!0,get:()=>a[r]})}}return o.default=a,Object.freeze(o)}const A=wt(yt);function At(a,o){function r(){this.constructor=a}r.prototype=o.prototype,a.prototype=new r}function P(a,o,r,h){var m=Error.call(this,a);return Object.setPrototypeOf&&Object.setPrototypeOf(m,P.prototype),m.expected=o,m.found=r,m.location=h,m.name="SyntaxError",m}At(P,Error);function K(a,o,r){return r=r||" ",a.length>o?a:(o-=a.length,r+=r.repeat(o),a+r.slice(0,o))}P.prototype.format=function(a){var o="Error: "+this.message;if(this.location){var r=null,h;for(h=0;h<a.length;h++)if(a[h].source===this.location.source){r=a[h].text.split(/\r\n|\n|\r/g);break}var m=this.location.start,_=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(m):m,b=this.location.source+":"+_.line+":"+_.column;if(r){var y=this.location.end,C=K("",_.line.toString().length," "),p=r[m.line-1],g=m.line===y.line?y.column:p.length+1,w=g-m.column||1;o+=`
 --> `+b+`
`+C+` |
`+_.line+" | "+p+`
`+C+" | "+K("",m.column-1," ")+K("",w,"^")}else o+=`
 at `+b}return o};P.buildMessage=function(a,o){var r={literal:function(p){return'"'+m(p.text)+'"'},class:function(p){var g=p.parts.map(function(w){return Array.isArray(w)?_(w[0])+"-"+_(w[1]):_(w)});return"["+(p.inverted?"^":"")+g.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(p){return p.description}};function h(p){return p.charCodeAt(0).toString(16).toUpperCase()}function m(p){return p.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+h(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+h(g)})}function _(p){return p.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+h(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+h(g)})}function b(p){return r[p.type](p)}function y(p){var g=p.map(b),w,x;if(g.sort(),g.length>0){for(w=1,x=1;w<g.length;w++)g[w-1]!==g[w]&&(g[x]=g[w],x++);g.length=x}switch(g.length){case 1:return g[0];case 2:return g[0]+" or "+g[1];default:return g.slice(0,-1).join(", ")+", or "+g[g.length-1]}}function C(p){return p?'"'+m(p)+'"':"end of input"}return"Expected "+y(a)+" but "+C(o)+" found."};function Re(a,o){o=o!==void 0?o:{};var r={},h=o.grammarSource,m={start:Ee},_=Ee,b=".",y="-",C="+",p="0",g=",",w="|",x='"',qe="'",Ie="#",Ne="^",ze="_",Y="[",ee="]",Be="{",Me="}",We="%",Ze="<",Ge=">",Ue="@",Xe="!",He="(",Je=")",Ke="/",Qe="*",Ve="?",Ye=":",re="struct",se="target",te="euclid",ne="slow",ae="rotL",ie="rotR",fe="fast",oe="scale",ce="//",le="cat",er="$",ue="setcps",pe="setbpm",ge="hush",rr=/^[1-9]/,sr=/^[eE]/,tr=/^[0-9]/,ve=/^[ \n\r\t]/,nr=/^[0-9a-zA-Z~]/,$e=/^[^\n]/,ar=Ce("number"),he=$(".",!1),ir=k([["1","9"]],!1,!1),fr=k(["e","E"],!1,!1),me=$("-",!1),or=$("+",!1),cr=$("0",!1),lr=k([["0","9"]],!1,!1),ur=Ce("whitespace"),_e=k([" ",`
`,"\r","	"],!1,!1),pr=$(",",!1),gr=$("|",!1),vr=$('"',!1),$r=$("'",!1),hr=k([["0","9"],["a","z"],["A","Z"],"~"],!1,!1),mr=$("#",!1),_r=$("^",!1),dr=$("_",!1),de=$("[",!1),ye=$("]",!1),yr=$("{",!1),wr=$("}",!1),Ar=$("%",!1),br=$("<",!1),Cr=$(">",!1),xr=$("@",!1),Er=$("!",!1),Sr=$("(",!1),jr=$(")",!1),Fr=$("/",!1),Pr=$("*",!1),kr=$("?",!1),Lr=$(":",!1),Or=$("struct",!1),Rr=$("target",!1),Dr=$("euclid",!1),Tr=$("slow",!1),qr=$("rotL",!1),Ir=$("rotR",!1),Nr=$("fast",!1),zr=$("scale",!1),Br=$("//",!1),we=k([`
`],!0,!1),Mr=$("cat",!1),Wr=$("$",!1),Zr=$("setcps",!1),Gr=$("setbpm",!1),Ur=$("hush",!1),Xr=function(){return parseFloat(Fs())},Hr=function(e){return new mt(e.join(""))},Jr=function(e){return e},Kr=function(e,s){return e.arguments_.stepsPerCycle=s,e},Qr=function(e){return e},Vr=function(e){return e.arguments_.alignment="slowcat",e},Yr=function(e){return s=>s.options_.weight=e},es=function(e){return s=>s.options_.reps=e},rs=function(e,s,n){return i=>i.options_.ops.push({type_:"bjorklund",arguments_:{pulse:e,step:s,rotation:n}})},ss=function(e){return s=>s.options_.ops.push({type_:"stretch",arguments_:{amount:e,type:"slow"}})},ts=function(e){return s=>s.options_.ops.push({type_:"stretch",arguments_:{amount:e,type:"fast"}})},ns=function(e){return s=>s.options_.ops.push({type_:"degradeBy",arguments_:{amount:e,seed:Oe++}})},as=function(e){return s=>s.options_.ops.push({type_:"tail",arguments_:{element:e}})},is=function(e,s){const n=new dt(e,{ops:[],weight:1,reps:1});for(const i of s)i(n);return n},fs=function(e){return new G(e,"fastcat")},os=function(e){return{alignment:"stack",list:e}},cs=function(e){return{alignment:"rand",list:e,seed:Oe++}},ls=function(e,s){return s&&s.list.length>0?new G([e,...s.list],s.alignment,s.seed):e},us=function(e,s){return new G(s?[e,...s.list]:[e],"polymeter")},ps=function(e){return e},gs=function(e){return{name:"struct",args:{mini:e}}},vs=function(e){return{name:"target",args:{name:e}}},$s=function(e,s,n){return{name:"bjorklund",args:{pulse:e,step:parseInt(s)}}},hs=function(e){return{name:"stretch",args:{amount:e}}},ms=function(e){return{name:"shift",args:{amount:"-"+e}}},_s=function(e){return{name:"shift",args:{amount:e}}},ds=function(e){return{name:"stretch",args:{amount:"1/"+e}}},ys=function(e){return{name:"scale",args:{scale:e.join("")}}},Ae=function(e,s){return s},ws=function(e,s){return s.unshift(e),new G(s,"slowcat")},As=function(e){return e},bs=function(e,s){return new _t(e.name,e.args,s)},Cs=function(e){return e},xs=function(e){return e},Es=function(e){return new J("setcps",{value:e})},Ss=function(e){return new J("setcps",{value:e/120/2})},js=function(){return new J("hush")},t=0,v=0,B=[{line:1,column:1}],S=0,U=[],f=0,M;if("startRule"in o){if(!(o.startRule in m))throw new Error(`Can't start parsing from rule "`+o.startRule+'".');_=m[o.startRule]}function Fs(){return a.substring(v,t)}function be(){return X(v,t)}function $(e,s){return{type:"literal",text:e,ignoreCase:s}}function k(e,s,n){return{type:"class",parts:e,inverted:s,ignoreCase:n}}function Ps(){return{type:"end"}}function Ce(e){return{type:"other",description:e}}function xe(e){var s=B[e],n;if(s)return s;for(n=e-1;!B[n];)n--;for(s=B[n],s={line:s.line,column:s.column};n<e;)a.charCodeAt(n)===10?(s.line++,s.column=1):s.column++,n++;return B[e]=s,s}function X(e,s,n){var i=xe(e),l=xe(s),d={source:h,start:{offset:e,line:i.line,column:i.column},end:{offset:s,line:l.line,column:l.column}};return n&&h&&typeof h.offset=="function"&&(d.start=h.offset(d.start),d.end=h.offset(d.end)),d}function c(e){t<S||(t>S&&(S=t,U=[]),U.push(e))}function ks(e,s,n){return new P(P.buildMessage(e,s),e,s,n)}function Ee(){var e;return e=ht(),e}function j(){var e,s;return f++,e=t,Se(),s=W(),s!==r?(Ts(),Ds(),v=e,e=Xr()):(t=e,e=r),f--,e===r&&f===0&&c(ar),e}function Ls(){var e;return a.charCodeAt(t)===46?(e=b,t++):(e=r,f===0&&c(he)),e}function Os(){var e;return rr.test(a.charAt(t))?(e=a.charAt(t),t++):(e=r,f===0&&c(ir)),e}function Rs(){var e;return sr.test(a.charAt(t))?(e=a.charAt(t),t++):(e=r,f===0&&c(fr)),e}function Ds(){var e,s,n,i,l;if(e=t,s=Rs(),s!==r){if(n=Se(),n===r&&(n=qs()),n===r&&(n=null),i=[],l=L(),l!==r)for(;l!==r;)i.push(l),l=L();else i=r;i!==r?(s=[s,n,i],e=s):(t=e,e=r)}else t=e,e=r;return e}function Ts(){var e,s,n,i;if(e=t,s=Ls(),s!==r){if(n=[],i=L(),i!==r)for(;i!==r;)n.push(i),i=L();else n=r;n!==r?(s=[s,n],e=s):(t=e,e=r)}else t=e,e=r;return e}function W(){var e,s,n,i;if(e=Is(),e===r)if(e=t,s=Os(),s!==r){for(n=[],i=L();i!==r;)n.push(i),i=L();s=[s,n],e=s}else t=e,e=r;return e}function Se(){var e;return a.charCodeAt(t)===45?(e=y,t++):(e=r,f===0&&c(me)),e}function qs(){var e;return a.charCodeAt(t)===43?(e=C,t++):(e=r,f===0&&c(or)),e}function Is(){var e;return a.charCodeAt(t)===48?(e=p,t++):(e=r,f===0&&c(cr)),e}function L(){var e;return tr.test(a.charAt(t))?(e=a.charAt(t),t++):(e=r,f===0&&c(lr)),e}function u(){var e,s;for(f++,e=[],ve.test(a.charAt(t))?(s=a.charAt(t),t++):(s=r,f===0&&c(_e));s!==r;)e.push(s),ve.test(a.charAt(t))?(s=a.charAt(t),t++):(s=r,f===0&&c(_e));return f--,s=r,f===0&&c(ur),e}function O(){var e,s,n,i;return e=t,s=u(),a.charCodeAt(t)===44?(n=g,t++):(n=r,f===0&&c(pr)),n!==r?(i=u(),s=[s,n,i],e=s):(t=e,e=r),e}function je(){var e,s,n,i;return e=t,s=u(),a.charCodeAt(t)===124?(n=w,t++):(n=r,f===0&&c(gr)),n!==r?(i=u(),s=[s,n,i],e=s):(t=e,e=r),e}function R(){var e;return a.charCodeAt(t)===34?(e=x,t++):(e=r,f===0&&c(vr)),e===r&&(a.charCodeAt(t)===39?(e=qe,t++):(e=r,f===0&&c($r))),e}function Z(){var e;return nr.test(a.charAt(t))?(e=a.charAt(t),t++):(e=r,f===0&&c(hr)),e===r&&(a.charCodeAt(t)===45?(e=y,t++):(e=r,f===0&&c(me)),e===r&&(a.charCodeAt(t)===35?(e=Ie,t++):(e=r,f===0&&c(mr)),e===r&&(a.charCodeAt(t)===46?(e=b,t++):(e=r,f===0&&c(he)),e===r&&(a.charCodeAt(t)===94?(e=Ne,t++):(e=r,f===0&&c(_r)),e===r&&(a.charCodeAt(t)===95?(e=ze,t++):(e=r,f===0&&c(dr))))))),e}function Fe(){var e,s,n;if(e=t,u(),s=[],n=Z(),n!==r)for(;n!==r;)s.push(n),n=Z();else s=r;return s!==r?(n=u(),v=e,e=Hr(s)):(t=e,e=r),e}function Ns(){var e,s,n,i;return e=t,u(),a.charCodeAt(t)===91?(s=Y,t++):(s=r,f===0&&c(de)),s!==r?(u(),n=Le(),n!==r?(u(),a.charCodeAt(t)===93?(i=ee,t++):(i=r,f===0&&c(ye)),i!==r?(u(),v=e,e=Jr(n)):(t=e,e=r)):(t=e,e=r)):(t=e,e=r),e}function zs(){var e,s,n,i,l;return e=t,u(),a.charCodeAt(t)===123?(s=Be,t++):(s=r,f===0&&c(yr)),s!==r?(u(),n=Qs(),n!==r?(u(),a.charCodeAt(t)===125?(i=Me,t++):(i=r,f===0&&c(wr)),i!==r?(l=Bs(),l===r&&(l=null),u(),v=e,e=Kr(n,l)):(t=e,e=r)):(t=e,e=r)):(t=e,e=r),e}function Bs(){var e,s,n;return e=t,a.charCodeAt(t)===37?(s=We,t++):(s=r,f===0&&c(Ar)),s!==r?(n=I(),n!==r?(v=e,e=Qr(n)):(t=e,e=r)):(t=e,e=r),e}function Ms(){var e,s,n,i;return e=t,u(),a.charCodeAt(t)===60?(s=Ze,t++):(s=r,f===0&&c(br)),s!==r?(u(),n=F(),n!==r?(u(),a.charCodeAt(t)===62?(i=Ge,t++):(i=r,f===0&&c(Cr)),i!==r?(u(),v=e,e=Vr(n)):(t=e,e=r)):(t=e,e=r)):(t=e,e=r),e}function I(){var e;return e=Fe(),e===r&&(e=Ns(),e===r&&(e=zs(),e===r&&(e=Ms()))),e}function Pe(){var e;return e=Ws(),e===r&&(e=Gs(),e===r&&(e=Us(),e===r&&(e=Xs(),e===r&&(e=Zs(),e===r&&(e=Hs(),e===r&&(e=Js())))))),e}function Ws(){var e,s,n;return e=t,a.charCodeAt(t)===64?(s=Ue,t++):(s=r,f===0&&c(xr)),s!==r?(n=j(),n!==r?(v=e,e=Yr(n)):(t=e,e=r)):(t=e,e=r),e}function Zs(){var e,s,n;return e=t,a.charCodeAt(t)===33?(s=Xe,t++):(s=r,f===0&&c(Er)),s!==r?(n=j(),n!==r?(v=e,e=es(n)):(t=e,e=r)):(t=e,e=r),e}function Gs(){var e,s,n,i,l,d,E;return e=t,a.charCodeAt(t)===40?(s=He,t++):(s=r,f===0&&c(Sr)),s!==r?(u(),n=N(),n!==r?(u(),i=O(),i!==r?(u(),l=N(),l!==r?(u(),O(),u(),d=N(),d===r&&(d=null),u(),a.charCodeAt(t)===41?(E=Je,t++):(E=r,f===0&&c(jr)),E!==r?(v=e,e=rs(n,l,d)):(t=e,e=r)):(t=e,e=r)):(t=e,e=r)):(t=e,e=r)):(t=e,e=r),e}function Us(){var e,s,n;return e=t,a.charCodeAt(t)===47?(s=Ke,t++):(s=r,f===0&&c(Fr)),s!==r?(n=I(),n!==r?(v=e,e=ss(n)):(t=e,e=r)):(t=e,e=r),e}function Xs(){var e,s,n;return e=t,a.charCodeAt(t)===42?(s=Qe,t++):(s=r,f===0&&c(Pr)),s!==r?(n=I(),n!==r?(v=e,e=ts(n)):(t=e,e=r)):(t=e,e=r),e}function Hs(){var e,s,n;return e=t,a.charCodeAt(t)===63?(s=Ve,t++):(s=r,f===0&&c(kr)),s!==r?(n=j(),n===r&&(n=null),v=e,e=ns(n)):(t=e,e=r),e}function Js(){var e,s,n;return e=t,a.charCodeAt(t)===58?(s=Ye,t++):(s=r,f===0&&c(Lr)),s!==r?(n=I(),n!==r?(v=e,e=as(n)):(t=e,e=r)):(t=e,e=r),e}function N(){var e,s,n,i;if(e=t,s=I(),s!==r){for(n=[],i=Pe();i!==r;)n.push(i),i=Pe();v=e,e=is(s,n)}else t=e,e=r;return e}function F(){var e,s,n;if(e=t,s=[],n=N(),n!==r)for(;n!==r;)s.push(n),n=N();else s=r;return s!==r&&(v=e,s=fs(s)),e=s,e}function ke(){var e,s,n,i,l;if(e=t,s=[],n=t,i=O(),i!==r?(l=F(),l!==r?n=l:(t=n,n=r)):(t=n,n=r),n!==r)for(;n!==r;)s.push(n),n=t,i=O(),i!==r?(l=F(),l!==r?n=l:(t=n,n=r)):(t=n,n=r);else s=r;return s!==r&&(v=e,s=os(s)),e=s,e}function Ks(){var e,s,n,i,l;if(e=t,s=[],n=t,i=je(),i!==r?(l=F(),l!==r?n=l:(t=n,n=r)):(t=n,n=r),n!==r)for(;n!==r;)s.push(n),n=t,i=je(),i!==r?(l=F(),l!==r?n=l:(t=n,n=r)):(t=n,n=r);else s=r;return s!==r&&(v=e,s=cs(s)),e=s,e}function Le(){var e,s,n;return e=t,s=F(),s!==r?(n=ke(),n===r&&(n=Ks()),n===r&&(n=null),v=e,e=ls(s,n)):(t=e,e=r),e}function Qs(){var e,s,n;return e=t,s=F(),s!==r?(n=ke(),n===r&&(n=null),v=e,e=us(s,n)):(t=e,e=r),e}function Vs(){var e,s,n,i;return e=t,u(),s=R(),s!==r?(u(),n=Le(),n!==r?(u(),i=R(),i!==r?(v=e,e=ps(n)):(t=e,e=r)):(t=e,e=r)):(t=e,e=r),e}function Ys(){var e;return e=ft(),e===r&&(e=tt(),e===r&&(e=it(),e===r&&(e=rt(),e===r&&(e=st(),e===r&&(e=et(),e===r&&(e=at(),e===r&&(e=nt()))))))),e}function et(){var e,s,n;return e=t,a.substr(t,6)===re?(s=re,t+=6):(s=r,f===0&&c(Or)),s!==r?(u(),n=D(),n!==r?(v=e,e=gs(n)):(t=e,e=r)):(t=e,e=r),e}function rt(){var e,s,n,i,l;return e=t,a.substr(t,6)===se?(s=se,t+=6):(s=r,f===0&&c(Rr)),s!==r?(u(),n=R(),n!==r?(i=Fe(),i!==r?(l=R(),l!==r?(v=e,e=vs(i)):(t=e,e=r)):(t=e,e=r)):(t=e,e=r)):(t=e,e=r),e}function st(){var e,s,n,i;return e=t,a.substr(t,6)===te?(s=te,t+=6):(s=r,f===0&&c(Dr)),s!==r?(u(),n=W(),n!==r?(u(),i=W(),i!==r?(u(),W(),v=e,e=$s(n,i)):(t=e,e=r)):(t=e,e=r)):(t=e,e=r),e}function tt(){var e,s,n;return e=t,a.substr(t,4)===ne?(s=ne,t+=4):(s=r,f===0&&c(Tr)),s!==r?(u(),n=j(),n!==r?(v=e,e=hs(n)):(t=e,e=r)):(t=e,e=r),e}function nt(){var e,s,n;return e=t,a.substr(t,4)===ae?(s=ae,t+=4):(s=r,f===0&&c(qr)),s!==r?(u(),n=j(),n!==r?(v=e,e=ms(n)):(t=e,e=r)):(t=e,e=r),e}function at(){var e,s,n;return e=t,a.substr(t,4)===ie?(s=ie,t+=4):(s=r,f===0&&c(Ir)),s!==r?(u(),n=j(),n!==r?(v=e,e=_s(n)):(t=e,e=r)):(t=e,e=r),e}function it(){var e,s,n;return e=t,a.substr(t,4)===fe?(s=fe,t+=4):(s=r,f===0&&c(Nr)),s!==r?(u(),n=j(),n!==r?(v=e,e=ds(n)):(t=e,e=r)):(t=e,e=r),e}function ft(){var e,s,n,i,l;if(e=t,a.substr(t,5)===oe?(s=oe,t+=5):(s=r,f===0&&c(zr)),s!==r)if(u(),n=R(),n!==r){if(i=[],l=Z(),l!==r)for(;l!==r;)i.push(l),l=Z();else i=r;i!==r?(l=R(),l!==r?(v=e,e=ys(i)):(t=e,e=r)):(t=e,e=r)}else t=e,e=r;else t=e,e=r;return e}function H(){var e,s,n,i;if(e=t,a.substr(t,2)===ce?(s=ce,t+=2):(s=r,f===0&&c(Br)),s!==r){for(n=[],$e.test(a.charAt(t))?(i=a.charAt(t),t++):(i=r,f===0&&c(we));i!==r;)n.push(i),$e.test(a.charAt(t))?(i=a.charAt(t),t++):(i=r,f===0&&c(we));s=[s,n],e=s}else t=e,e=r;return e}function ot(){var e,s,n,i,l,d,E,T;if(e=t,a.substr(t,3)===le?(s=le,t+=3):(s=r,f===0&&c(Mr)),s!==r)if(u(),a.charCodeAt(t)===91?(n=Y,t++):(n=r,f===0&&c(de)),n!==r)if(u(),i=D(),i!==r){for(l=[],d=t,E=O(),E!==r?(T=D(),T!==r?(v=d,d=Ae(i,T)):(t=d,d=r)):(t=d,d=r);d!==r;)l.push(d),d=t,E=O(),E!==r?(T=D(),T!==r?(v=d,d=Ae(i,T)):(t=d,d=r)):(t=d,d=r);d=u(),a.charCodeAt(t)===93?(E=ee,t++):(E=r,f===0&&c(ye)),E!==r?(v=e,e=ws(i,l)):(t=e,e=r)}else t=e,e=r;else t=e,e=r;else t=e,e=r;return e}function ct(){var e;return e=ot(),e===r&&(e=Vs()),e}function D(){var e,s,n,i,l;if(e=t,s=ct(),s!==r){for(u(),n=[],i=H();i!==r;)n.push(i),i=H();v=e,e=As(s)}else t=e,e=r;return e===r&&(e=t,s=Ys(),s!==r?(u(),a.charCodeAt(t)===36?(n=er,t++):(n=r,f===0&&c(Wr)),n!==r?(i=u(),l=D(),l!==r?(v=e,e=bs(s,l)):(t=e,e=r)):(t=e,e=r)):(t=e,e=r)),e}function lt(){var e,s;return e=t,s=D(),s!==r&&(v=e,s=Cs(s)),e=s,e===r&&(e=H()),e}function ut(){var e;return e=lt(),e}function pt(){var e,s;return e=t,u(),s=gt(),s===r&&(s=vt(),s===r&&(s=$t())),s!==r?(u(),v=e,e=xs(s)):(t=e,e=r),e}function gt(){var e,s,n;return e=t,a.substr(t,6)===ue?(s=ue,t+=6):(s=r,f===0&&c(Zr)),s!==r?(u(),n=j(),n!==r?(v=e,e=Es(n)):(t=e,e=r)):(t=e,e=r),e}function vt(){var e,s,n;return e=t,a.substr(t,6)===pe?(s=pe,t+=6):(s=r,f===0&&c(Gr)),s!==r?(u(),n=j(),n!==r?(v=e,e=Ss(n)):(t=e,e=r)):(t=e,e=r),e}function $t(){var e,s;return e=t,a.substr(t,4)===ge?(s=ge,t+=4):(s=r,f===0&&c(Ur)),s!==r&&(v=e,s=js()),e=s,e}function ht(){var e;return e=ut(),e===r&&(e=pt()),e}var mt=function(e){this.type_="atom",this.source_=e,this.location_=be()},G=function(e,s,n){this.type_="pattern",this.arguments_={alignment:s},n!==void 0&&(this.arguments_.seed=n),this.source_=e},_t=function(e,s,n){this.type_=e,this.arguments_=s,this.source_=n},dt=function(e,s){this.type_="element",this.source_=e,this.options_=s,this.location_=be()},J=function(e,s){this.type_="command",this.name_=e,this.options_=s},Oe=0;if(M=_(),M!==r&&t===a.length)return M;throw M!==r&&t<a.length&&c(Ps()),ks(U,S<a.length?a.charAt(S):null,S<a.length?X(S,S+1):X(S,S))}const De=3e-4,bt=(a,o)=>(r,h)=>{const b=a.source_[h].options_?.ops;if(b)for(const y of b)switch(y.type_){case"stretch":{const C=["fast","slow"],{type:p,amount:g}=y.arguments_;if(!C.includes(p))throw new Error(`mini: stretch: type must be one of ${C.join("|")} but got ${p}`);r=A.reify(r)[p](o(g));break}case"bjorklund":{y.arguments_.rotation?r=r.euclidRot(o(y.arguments_.pulse),o(y.arguments_.step),o(y.arguments_.rotation)):r=r.euclid(o(y.arguments_.pulse),o(y.arguments_.step));break}case"degradeBy":{r=A.reify(r)._degradeByWith(A.rand.early(De*y.arguments_.seed),y.arguments_.amount??.5);break}case"tail":{const C=o(y.arguments_.element);r=r.fmap(p=>g=>Array.isArray(p)?[...p,g]:[p,g]).appLeft(C);break}default:console.warn(`operator "${y.type_}" not implemented`)}return r};function Ct(a){a.source_=A.flatten(a.source_.map(o=>{const{reps:r}=o.options_||{};return r?(delete o.options_.reps,Array(r).fill(o)):[o]}))}function q(a,o,r,h=0){r?.(a);const m=_=>q(_,o,r,h);switch(a.type_){case"pattern":{Ct(a);const _=a.source_.map(p=>m(p)).map(bt(a,m)),b=a.arguments_.alignment;if(b==="stack")return A.stack(..._);if(b==="polymeter"){const p=a.arguments_.stepsPerCycle?m(a.arguments_.stepsPerCycle).fmap(w=>A.Fraction(w)):A.pure(A.Fraction(_.length>0?_[0].__weight:1)),g=_.map(w=>w.fast(p.fmap(x=>x.div(w.__weight||1))));return A.stack(...g)}if(b==="rand")return A.chooseInWith(A.rand.early(De*a.arguments_.seed).segment(1),_);const y=a.source_.some(p=>!!p.options_?.weight);if(!y&&b==="slowcat")return A.slowcat(..._);if(y){const p=a.source_.reduce((w,x)=>w+(x.options_?.weight||1),0),g=A.timeCat(...a.source_.map((w,x)=>[w.options_?.weight||1,_[x]]));return b==="slowcat"?g._slow(p):(g.__weight=p,g)}const C=A.sequence(..._);return C.__weight=_.length,C}case"element":return m(a.source_);case"atom":{if(a.source_==="~")return A.silence;if(!a.location_)return console.warn("no location for",a),a.source_;const _=isNaN(Number(a.source_))?a.source_:Number(a.source_);if(h===-1)return A.pure(_);const[b,y]=Q(o,a,h);return A.pure(_).withLoc(b,y)}case"stretch":return m(a.source_).slow(m(a.arguments_.amount));default:return console.warn(`node type "${a.type_}" not implemented -> returning silence`),A.silence}}const Q=(a,o,r=0)=>{const{start:h,end:m}=o.location_,_=a?.split("").slice(h.offset,m.offset).join(""),[b=0,y=0]=_?_.split(o.source_).map(C=>C.split("").filter(p=>p===" ").length):[];return[h.offset+b+r,m.offset-y+r]},z=a=>Re(a),Te=a=>{const o=z(a);let r=[];return q(o,a,h=>{h.type_==="atom"&&r.push(h)},-1),r},xt=(a,o=0)=>Te(a).map(r=>Q(a,r,o)),V=(...a)=>{const o=a.map(r=>{const h=`"${r}"`,m=z(h);return q(m,h)});return A.sequence(...o)},Et=(a,o)=>{const r=`"${a}"`,h=z(r);return q(h,r,null,o)},St=a=>{const o=z(a);return q(o,a)};function jt(a){return typeof a=="string"?V(a):A.reify(a)}function Ft(){A.setStringParser(V)}exports.SyntaxError=P;exports.getLeafLocation=Q;exports.getLeafLocations=xt;exports.getLeaves=Te;exports.h=St;exports.m=Et;exports.mini=V;exports.mini2ast=z;exports.miniAllStrings=Ft;exports.minify=jt;exports.parse=Re;exports.patternifyAST=q;
